# Docker Registry

![Version: 0.1.0](https://img.shields.io/badge/Version-0.1.0-informational?style=flat-square) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![AppVersion: 2.8.1](https://img.shields.io/badge/AppVersion-2.8.1-informational?style=flat-square)

## TL;DR

```console
helm install test-release .
```

## Introduction

This [Helm](https://helm.sh) chart installs a private [Docker](https://www.docker.com/) [Registry](https://docs.docker.com/registry/) using the [Open Source Registry](https://github.com/distribution/distribution) implementation.

## Prerequisites

- Kubernetes 1.21+
- Helm 3.1+

## Installing the Chart

To install the chart with the release name `dev-release`:

```console
cd spt-charts
helm install dev-release .
```

These commands deploy the Docker Registry on the [Kubernetes](https://kubernetes.io) cluster in the default configuration. The [Parameters](#parameters) section lists the parameters that can be configured during installation.

## Uninstalling the Chart

To uninstall/delete the `dev-release` deployment:

```console
helm uninstall dev-release
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Parameters

| Key                                        | Type   | Default                                                                                                  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|--------------------------------------------|--------|----------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| affinity                                   | object | `{}`                                                                                                     | Affinity for pod assignment. ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity NOTE: podAffinityPreset, podAntiAffinityPreset, and nodeAffinityPreset will be ignored when set                                                                                                                                                                                                                                                                                                                                                                         |
| autoscaling.enabled                        | bool   | `false`                                                                                                  | Enable auto-scaling for the Registry.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| autoscaling.maxReplicas                    | int    | `100`                                                                                                    | Maximum number of replicas that can be deployed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| autoscaling.minReplicas                    | int    | `1`                                                                                                      | Minimum number of replicas to deploy.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| autoscaling.targetCPUUtilizationPercentage | int    | `80`                                                                                                     | Target CPU utilization (percent) for each replica.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fullnameOverride                           | string | `""`                                                                                                     | Overrides the fully-qualified app name generated for resources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| image.pullPolicy                           | string | `"IfNotPresent"`                                                                                         | Registry image pull policy (Always                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |IfNotPresent). |
| image.repository                           | string | `"docker.io/registry"`                                                                                   | Registry image name.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| image.tag                                  | string | `""`                                                                                                     | Overrides the image tag (default is the chart appVersion).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| imagePullSecrets                           | list   | `[]`                                                                                                     | List of image repository pull secrets. Secrets must be manually created in the namespace. ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/ Example: imagePullSecrets:   - name: myRegistryKeySecretName                                                                                                                                                                                                                                                                                                                                                       |
| ingress.annotations                        | object | `{}`                                                                                                     | Additional annotations for the Ingress resource. To enable certificate auto-generation, place cert-manager annotations here. For a full list of possible ingress annotations, please see ref: https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md Use this parameter to set the required annotations for cert-manager, see ref: https://cert-manager.io/docs/usage/ingress/#supported-annotations  e.g: annotations:   kubernetes.io/ingress.class: nginx   cert-manager.io/cluster-issuer: cluster-issuer-name   kubernetes.io/tls-acme: "true" |
| ingress.className                          | string | `""`                                                                                                     | Name of an IngressClass cluster resource.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ingress.enabled                            | bool   | `false`                                                                                                  | Enable Ingress resource generation for Registry.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ingress.host                               | string | `nil`                                                                                                    | Defines is the fully-qualified domain name of this Ingress' host.  - host: "chart-example.local"    paths:      # A collection of paths that map requests to backends.      - path: /        # Determines the interpretation of the Path matching.        pathType: ImplementationSpecific                                                                                                                                                                                                                                                                                                              |
| ingress.path                               | string | `"/"`                                                                                                    | A path mapping that corresponds to the Registry backend. If left blank, the path defaults to `/`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ingress.tls.clusterIssuer                  | string | `""`                                                                                                     | Name of the Cluster Issuer to use.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ingress.tls.enabled                        | bool   | `true`                                                                                                   | Determines whether TLS is enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ingress.tls.secretName                     | string | `""`                                                                                                     | Name of a Secret containing an existing TLS certificate. If using a Cluster Issuer, this will determine the name of the Secret the issuer creates.                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| livenessProbe.failureThreshold             | int    | `5`                                                                                                      | Number of consecutive negative tests before declaring failure                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| livenessProbe.initialDelaySeconds          | int    | `5`                                                                                                      | Initial delay before probing liveness                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| livenessProbe.periodSeconds                | int    | `30`                                                                                                     | Period in seconds between liveness checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| livenessProbe.successThreshold             | int    | `1`                                                                                                      | Number of consecutive positive tests before counting it as a success                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| livenessProbe.timeoutSeconds               | int    | `1`                                                                                                      | Timeout in seconds for liveness checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| nameOverride                               | string | `""`                                                                                                     | Overrides the default name assigned to resources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| nodeSelector                               | object | `{}`                                                                                                     | Node labels for pod assignment. ref: https://kubernetes.io/docs/user-guide/node-selection/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| persistence.accessModes                    | list   | `["ReadWriteOnce"]`                                                                                      | PVC Access Mode for the Registry data volume.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| persistence.deleteEnabled                  | bool   | `false`                                                                                                  | Whether to allow images to be deleted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| persistence.enabled                        | bool   | `true`                                                                                                   | Enable Registry server data persistence using a PVC.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| persistence.existingClaim                  | string | `""`                                                                                                     | Name of an existing PVC to use.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| persistence.size                           | string | `"100Gi"`                                                                                                | PVC Storage Request for the Registry data volume.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| persistence.storageClass                   | string | `""`                                                                                                     | If defined, storageClassName: <storageClass> If set to "-", storageClassName: "", which disables dynamic provisioning. If undefined (the default) or set to null, no storageClassName spec is set, choosing the default provisioner. (gp2 on AWS, standard on GKE, AWS & OpenStack)                                                                                                                                                                                                                                                                                                                     |
| podAnnotations                             | object | `{}`                                                                                                     | Additional annotations for Registry pods.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| podSecurityContext                         | object | `{"fsGroup":1001,"runAsNonRoot":true,"runAsUser":1001}`                                                  | Configure the Registry pod security context. ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-pod                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| podSecurityContext.fsGroup                 | int    | `1001`                                                                                                   | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| podSecurityContext.runAsNonRoot            | bool   | `true`                                                                                                   | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| podSecurityContext.runAsUser               | int    | `1001`                                                                                                   | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| readinessProbe.failureThreshold            | int    | `5`                                                                                                      | Number of consecutive negative tests before declaring failure                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| readinessProbe.initialDelaySeconds         | int    | `3`                                                                                                      | Initial delay before probing readiness                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| readinessProbe.periodSeconds               | int    | `30`                                                                                                     | Period in seconds between readiness checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| readinessProbe.successThreshold            | int    | `1`                                                                                                      | Number of consecutive positive tests before counting it as a success                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| readinessProbe.timeoutSeconds              | int    | `1`                                                                                                      | Timeout in seconds for readiness checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| replicaCount                               | int    | `1`                                                                                                      | Number of Registry containers to deploy.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| resources                                  | object | `{}`                                                                                                     | Specifies the resources needed for the container to operate and limits, if any.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| secrets.haSharedSecret                     | string | `""`                                                                                                     | Shared secret for HTTP Basic authentication. If no value is specified, a random alphanumeric value will be generated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| secrets.htpasswd                           | string | `""`                                                                                                     | Enables HTTP-Basic authentication by specifying content in [Apache htpasswd format](https://httpd.apache.org/docs/2.4/programs/htpasswd.html). Only `bcrypt` format is supported. htpasswd:                                                                                                                                                                                                                                                                                                                                                                                                             |   foo:$2y$05$CiJ.aC8gIAMdVemlRP8rRO/o9G3L7ELPi156j39vxnrDCx3b/j3DC |
| securityContext                            | object | `{"allowPrivilegeEscalation":false,"capabilities":{"drop":["all"]},"privileged":false,"runAsUser":1001}` | Configure security context ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| securityContext.allowPrivilegeEscalation   | bool   | `false`                                                                                                  | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#privilege-escalation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| securityContext.capabilities               | object | `{"drop":["all"]}`                                                                                       | The default (recommended) configuration prohibits all Linux capabilities.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| securityContext.privileged                 | bool   | `false`                                                                                                  | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#privileged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| securityContext.runAsUser                  | int    | `1001`                                                                                                   | ref: https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| service.port                               | int    | `5000`                                                                                                   | Registry server port.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| service.type                               | string | `"ClusterIP"`                                                                                            | Type of Service to create (ClusterIP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |NodePort|LoadBalancer). |
| serviceAccount.annotations                 | object | `{}`                                                                                                     | Annotations to add to the service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| serviceAccount.create                      | bool   | `true`                                                                                                   | Specifies whether a service account should be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| serviceAccount.name                        | string | `""`                                                                                                     | The name of the service account to use. If not set and create is true, a name is generated using the fullname template.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| storage                                    | string | `"filesystem"`                                                                                           | Set the type of storage to use. Currently, only `filesystem` is supported.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| tlsSecretName                              | string | `""`                                                                                                     | Specifies the name of a Secret with a TLS certificate and key to mount. tlsSecretName: registry.docker.example.com                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| tolerations                                | list   | `[]`                                                                                                     | Tolerations for pod assignment. ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

## Using HTTP Basic Authentication

The simplest way to limit access to the images in the registry is to use basic authentication. To create a password file containing a single user (user `testuser` with password `testpass`), execute the following:

```console
docker run --entrypoint htpasswd httpd:2 -Bbn testuser testpass > htpasswd.file
```

The contents of the resulting file, `htpasswd.file`, can be passed to the registry with the `--set` command or a values file.
